# ðŸ“˜ **ROADMAP.md**
### _Manjaro ARM Pi 5 Installer â€” Phase 3 Roadmap_

## ðŸŽ¯ Phase 3 Goal  
Transform the installer into a **modular, pluginâ€‘driven, cyberdeckâ€‘ready Pi 5 deployment ecosystem** with:

- hardware abstraction  
- profileâ€‘based installs  
- advanced diagnostics  
- contributorâ€‘friendly architecture  

---

# ðŸ§± **Phase 3 Implementation Plan**

## **Step 1: Establish Foundation**

### **1.1 Unified Logging System**
**Goal**: Single logging API with text + JSON output.

**Actions**:
- Create `lib/log.sh` with:
  - Functions: `log_info`, `log_warn`, `log_error`, `log_debug`
  - `LOG_JSON=0/1` toggle and `LOG_FILE=/var/log/manjaro-installer/installer.log`
  - JSON lines format: `{"ts": "...", "level": "...", "phase": "...", "msg": "..."}`
- Replace ad-hoc `echo`/`printf` logging in `manjaro-pi5-installer-v2_6.sh` and wrapper with calls to `lib/log.sh`

### **1.2 Makefile (dev-shell/test/lint/docs)**
**Using container wrapper:**
- `make dev-shell` â†’ run container wrapper into interactive shell:
  - `bash manjaro-pi5-container-wrapper.sh --shell` (add `--shell` mode if needed)
- `make test` â†’ run bats tests inside container:
  - `docker/podman run ... bats test/`
- `make lint` â†’ run `shellcheck` on `*.sh`
- `make docs` â†’ build/update markdown docs (placeholder: `true` or simple script)

### **1.3 Linting + Testing**
- Add `shellcheck` as required tool; fix warnings per `copilot_guide.md` patterns
- Add `bats-core`:
  - `test/installer.bats` (boot verification, arg parsing, dry-run modes)
  - `test/plugins.bats` (loader behavior)
  - Run via `make test`

---

## **Step 2: Build Plugin Architecture**

### **2.1 Directory Structure**
Create plugin directories:
```
plugins/boot/
plugins/network/
plugins/hw/
plugins/diagnostics/
plugins/post-install/
```

### **2.2 Plugin Loader**
Create `lib/plugins.sh`:
- Discover `plugins/**/plugin-*.sh`
- Each plugin exports:
  - `PLUGIN_NAME`, `PLUGIN_VERSION`, `PLUGIN_DEPENDS=()`, `PLUGIN_PHASES=()`
  - `plugin_run_<phase>()` functions
- Resolve dependencies (simple topological sort; fail with clear error on cycles/missing deps)
- `plugins_run_phase "boot"` etc.

### **2.3 Function Extraction into Plugins**
From `manjaro-pi5-installer-v2_6.sh`:
- `copy_pi5_boot_files()` â†’ `plugins/boot/plugin-pi5-boot.sh`
- Wi-Fi TUI + nmcli functions â†’ `plugins/network/plugin-wifi.sh`
- `apply_optimizations()` â†’ `plugins/post-install/plugin-optimizations.sh`
- Keep existing error handling/logging patterns; main script calls `plugins_run_phase`

---

## **Step 3: Implement HAL and Profiles**

### **3.1 HAL Modules (`hal/`)**
Create detection modules:
- `hal/display.sh`, `hal/storage.sh`, `hal/overlay.sh`, `hal/sensor.sh`, `hal/usb.sh`
- Each exposes `hal_<domain>_detect` returning JSON via `jq` or manual echo
- Example: `hal_display_detect` â†’ `{"type":"hdmi","modes":["1920x1080@60"],"primary":true}`

### **3.2 Profiles**
Create profile files:
```
profiles/minimal.json
profiles/xfce.json
profiles/kde.json
profiles/cyberdeck.json
profiles/kiosk.json
```

**Profile schema fields**:
- `packages`, `services`, `optimizations`, `plugins`, `boot_strategy`, `network_defaults`

### **3.3 Refactor Edition Selection**
- `ui_select_edition()` â†’ `ui_select_profile()` reading from `profiles/*.json`
- `install_edition_packages()` â†’ `install_profile_packages()` using profile's `packages` list
- **Default**: if no profile chosen, behave like v2.6 minimal (backward-compatible)

---

## **Step 4: Add Advanced Features**

### **4.1 `--diagnostics` Mode**
**New CLI path**:
- Runs:
  - `verify_boot_partition()`
  - `diagnose_boot_partition()`
  - Overlay compatibility check (HAL + config.txt)
  - Container environment check (are we in ARM container? GLIBC version?)
  - Filesystem health (fsck dry-run or `tune2fs -l`/`dumpe2fs` summary)
- **Outputs**:
  - Human-readable text
  - Optional `--json` â†’ JSON report using unified logging format

### **4.2 Cyberdeck Profile**
Create `profiles/cyberdeck.json`:
- Extra packages: fan/battery tools, input drivers, gadget tools
- Plugins: `plugin-cyberdeck-display`, `plugin-cyberdeck-fan`, `plugin-cyberdeck-battery`, `plugin-cyberdeck-keyboard`, `plugin-usb-gadget`

**New HAL helpers for**:
- Custom display detection (SPI/DSI panels)
- Battery (I2C/ADC)
- Fan control (GPIO/PWM)

**Offline install**:
- Profile flag `offline: true` â†’ skip network, use local package cache/tarball

---

## **Step 5: Polish and Release**

### **5.1 Documentation**
Create comprehensive docs:
- `docs/architecture.md` â€” high-level diagram of phases, plugins, HAL, profiles
- `docs/plugins.md` â€” plugin API, lifecycle, examples
- `docs/hal.md` â€” detection contracts and JSON schema
- `docs/profiles.md` â€” profile schema + examples
- `docs/troubleshooting.md` â€” matrix keyed by symptoms (no boot, no X, no Wi-Fi, etc.)

### **5.2 CI Pipeline**
GitHub Actions:
- Spin up ARM container image
- Create loopback file as fake SD card
- Run `make lint` + `make test`
- Optionally run a "dry install" into loop device and run diagnostics

### **5.3 Release v3.0**
- Introduce semantic versioning (`v3.0.0`)
- Auto-generate changelog from tags/commits
- **Reduce main script**:
  - Move logic into `lib/` + `plugins/`
  - Keep `manjaro-pi5-installer.sh` as thin orchestrator **<500 lines**
- **Tag `v3.0` when**:
  - Plugin system, HAL, profiles, diagnostics, CI, and docs are all in place

---

# ðŸ“ **Implementation Strategy**

## **Refactoring Approach**
**Incremental extraction**: introduce `lib/` + `plugins/` + tests first, then migrate functions in small steps. Keeps v2.6 behavior stable and debuggable.

## **Testing Priority**
Implement **lint + bats + loop-device tests in Step 1**, before heavy refactors. That gives a safety net as you carve up the main script.

## **Backward Compatibility**
Keep **v2.6 behavior as default**: if no profile is chosen, use a built-in "minimal" profile equivalent and don't require plugins. Profiles and plugins should be additive, not mandatory, for v3.0  

---

# ðŸ Phase 3 Completion Criteria

- Installer is fully modular  
- Plugins are supported and documented  
- HAL is implemented  
- Profiles work endâ€‘toâ€‘end  
- Cyberdeck mode is functional  
- Diagnostics mode is robust  
- CI validates every commit  
- Documentation is complete  
